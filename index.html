<!DOCTYPE html>
<html>
<head>
  <title>Qubixia</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
<iframe name="page-content" src="https://qubixia.bubbleapps.io/version-test/" style="position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;">
  Your browser doesn't support iframes
</iframe>
<script>
const waitForIframeToLoad = () => new Promise((resolve) => {
    const myIframe = document.querySelector('iframe[name="page-content"]');
    myIframe.addEventListener('load', () => resolve());
});

//var Pi;

//async function main() {
    // Reload the iframe (if needed)
    //myIframe.contentWindow.location.reload(true);
    //await waitForIframeToLoad();
    //alert(Pi);
    //Pi = document.querySelector('iframe[name="page-content"]').contentWindow.Pi;
    //Pi.init({ version: "2.0", sandbox: false });
    //Pi.login();
    // Your further actions here...
//}

//main();
function onIncompletePaymentFound(payment) {
  alert('incomplete:'+payment);
};

function pi_login(){
  Pi.authenticate(['payments'], onIncompletePaymentFound).then(function(auth) {
    alert('authenticate:'+auth);
  }).catch(function(error) {
    alert('authenticate:'+error);
  });
}

window.addEventListener("message", (event) => {
  if (event.origin === "*") {
    const message = JSON.parse(event.data);
    if (message.type === i.r) {
      // The user has been authenticated.
      console.log("User authenticated.");
    } else {
      // The user was not authenticated.
      console.log("User not authenticated.");
    }
  }
});

var interval = setInterval(function() {
    console.log('Interval Running');
    if( Pi == "undefined" || Pi == ""){
      //Do Something While Waiting / Spinner Gif etc.
    }else{
      console.log('Interval Stopped');
      clearInterval(interval);
      Pi.init({ version: "2.0", sandbox: false });
      //Pi.authenticate(['payments'], onIncompletePaymentFound).then(function(auth) {
      //  alert('authenticate:'+auth);
      //}).catch(function(error) {
      //  alert('authenticate:'+error);
      //});
    }
  }, 1000);
</script>
</body>
</html>