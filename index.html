<!DOCTYPE html>
<html>
<head>
  <title>Qubixia</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
<iframe id="page-content" name="page-content" src="https://qubixia.bubbleapps.io/version-test/" style="position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;">
  Your browser doesn't support iframes
</iframe>
<script>

const waitForIframeToLoad = () => new Promise((resolve) => {
    const myIframe = document.querySelector('iframe[name="page-content"]');
    myIframe.addEventListener('load', () => resolve());
});

//var Pi;

//async function main() {
    // Reload the iframe (if needed)
    //myIframe.contentWindow.location.reload(true);
    //await waitForIframeToLoad();
    //alert(Pi);
    //Pi = document.querySelector('iframe[name="page-content"]').contentWindow.Pi;
    //Pi.init({ version: "2.0", sandbox: false });
    //Pi.login();
    // Your further actions here...
//}

//main();
const delay = ms => new Promise(res => setTimeout(res, ms));

function onIncompletePaymentFound(payment) {
  alert('incomplete:'+payment);
};

async function pi_login(count=0){
  Pi.authenticate(['payments'], onIncompletePaymentFound).then(function(auth) {
    alert('authenticate:'+auth);
    Pi.LoggedInUser = auth;
    document.getElementById("page-content").src = "/home";
  }).catch(async function(error) {
    if(count>=2){
      alert('Failed to authenticate after 3 attempts, please refresh the page to try again:'+error);
      Pi.LoggedInUser = null;
      return;
    }
    await delay(1000);
    pi_login(count+1);
  });
}

// Create a function to be executed when the post message is received
function executeFunction(data) {
  // Get the function name and the arguments
  const functionName = data.function;
  const args = data.args;

  // Check if the function exists in the parent window
  if (typeof window[functionName] === "function") {
    // If so, execute it with the given arguments
    window[functionName].apply(null, args);
  }
}

async function process_message(data, count=0){
  if(count>=2){return "ERROR: Failed to process message after 3 attempts.";}
  try {
    executeFunction(data);
  } catch (error) {
    await delay(1000);
    process_message(data, count+1)
  }
}

// Create a post message listener
window.addEventListener("message", function (event) {
  // Check if the message has a 'command' property
  if (event.data.hasOwnProperty("command")) {
    // Get the command and the data
    const command = event.data.command;
    const data = event.data.data || {};

    // Execute the appropriate function
    switch (command) {
      case "executeFunction":
        process_message(data)
        break;
      default:
        // Handle other commands as needed
    }
  }
});

var interval = setInterval(function() {
    console.log('Interval Running');
    if( Pi == "undefined" || Pi == ""){
      //Do Something While Waiting / Spinner Gif etc.
    }else{
      console.log('Interval Stopped');
      clearInterval(interval);
      Pi.init({ version: "2.0", sandbox: false });
      //Pi.authenticate(['payments'], onIncompletePaymentFound).then(function(auth) {
      //  alert('authenticate:'+auth);
      //}).catch(function(error) {
      //  alert('authenticate:'+error);
      //});
    }
  }, 1000);
</script>
</body>
</html>